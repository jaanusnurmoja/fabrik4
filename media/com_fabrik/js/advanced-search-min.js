/*! Fabrik */
AdvancedSearch=new Class({options:{ajax:!1,controller:"list",parentView:"",defaultStatement:"=",conditionList:"",elementList:"",elementMap:{},statementList:""},initialize:function(a){this.options=jQuery.extend(this.options,a),this.form=jQuery("form.advancedSearch_"+this.options.listref);var b=this.form.find(".advanced-search-add"),c=this.form.find(".advanced-search-clearall"),d=this;b.length>0&&(b.off("click"),b.on("click",function(a){a.preventDefault(),d.addRow()}),c.off("click"),c.on("click",function(a){d.resetForm(a)})),this.form.on("click","tr",function(){d.form.find("tr").removeClass("fabrikRowClick"),jQuery(this).addClass("fabrikRowClick")}),this.watchDelete(),this.watchApply(),this.watchElementList(),Fabrik.trigger("fabrik.advancedSearch.ready",this)},watchApply:function(){var a=this;this.form.find(".advanced-search-apply").on("click",function(b){Fabrik.fireEvent("fabrik.advancedSearch.submit",this);var c=Fabrik["filter_"+a.options.parentView];void 0!==c&&c.onSubmit();var d=a.getList();jQuery(document.createElement("input")).attr({name:"resetfilters",value:1,type:"hidden"}).appendTo(a.form),a.options.ajax&&(b.preventDefault(),d.submit(a.options.controller+".filter"))})},getList:function(){var a=Fabrik.blocks["list_"+this.options.listref];return void 0===a&&(a=Fabrik.blocks[this.options.parentView]),a},watchDelete:function(){var a=this;this.form.on("click",".advanced-search-remove-row",function(b){b.preventDefault(),a.removeRow(jQuery(this).closest("tr"))})},watchElementList:function(){var a=this;this.form.on("change","select.key",function(b){b.preventDefault();var c=jQuery(this).closest("tr"),d=jQuery(this).val();a.updateValueInput(c,d)})},updateValueInput:function(a,b){var c,d="index.php?option=com_fabrik&task=list.elementFilter&format=raw";Fabrik.loader.start(a[0]);var e=jQuery(a.find("td")[3]);return""===b?void e.html(""):(c=this.options.elementMap[b],void jQuery.ajax({url:d,data:{element:b,id:this.options.listid,elid:c.id,plugin:c.plugin,counter:this.options.counter,listref:this.options.listref,context:this.options.controller,parentView:this.options.parentView}}).done(function(b){e.html(b),Fabrik.loader.stop(a[0])}))},addRow:function(){this.options.counter++;var a=this.form.find(".advanced-search-list").find("tbody").find("tr").last(),b=a.clone();b.removeClass("oddRow1").removeClass("oddRow0").addClass("oddRow"+this.options.counter%2),a.after(b),b.find("td").first().empty().html(this.options.conditionList);var c=b.find("td"),d=jQuery(c[1]);d.empty().html(this.options.elementList),d.append([jQuery(document.createElement("input")).attr({type:"hidden",name:"fabrik___filter[list_"+this.options.listref+"][search_type][]",value:"advanced"}),jQuery(document.createElement("input")).attr({type:"hidden",name:"fabrik___filter[list_"+this.options.listref+"][grouped_to_previous][]",value:"0"})]),jQuery(c[2]).empty().html(this.options.statementList),jQuery(c[3]).empty(),Fabrik.trigger("fabrik.advancedSearch.row.added",this)},removeRow:function(a){this.form.find(".advanced-search-remove-row").length>1&&(this.options.counter--,a.animate({height:0,opacity:0},800,function(){a.remove()})),Fabrik.trigger("fabrik.advancedSearch.row.removed",this)},resetForm:function(){var a=this.form.find(".advanced-search-list"),b=this;a&&(a.find("tbody tr").each(function(a){a>=1&&jQuery(this).remove(),0===a&&(jQuery(this).find(".inputbox").each(function(){this.id.test(/condition$/)?this.value=b.options.defaultStatement:this.selectedIndex=0}),jQuery(this).find("input").each(function(){jQuery(this).val("")}))}),Fabrik.trigger("fabrik.advancedSearch.reset",this))},deleteFilterOption:function(a){var b=this;jQuery(a.target).off("click",function(a){b.deleteFilterOption(a)});var c=jQuery(a.target).parent().parent(),d=c.parent();d.removeChild(c),a.preventDefault()}});