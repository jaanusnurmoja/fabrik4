/*! Fabrik */
Fabrik.getWindow=function(a){if(Fabrik.Windows[a.id])a.visible!==!1&&Fabrik.Windows[a.id].open(),Fabrik.Windows[a.id].setOptions(a);else{var b=a.type?a.type:"";switch(b){case"redirect":Fabrik.Windows[a.id]=new Fabrik.RedirectWindow(a);break;case"modal":Fabrik.Windows[a.id]=new Fabrik.Modal(a);break;case"":default:Fabrik.Windows[a.id]=new Fabrik.Window(a)}}return Fabrik.Windows[a.id]},Fabrik.Window=new Class({Implements:[Events,Options],options:{id:"FabrikWindow",title:"&nbsp;",container:!1,loadMethod:"html",contentURL:"",createShowOverLay:!1,width:300,height:300,loadHeight:100,expandable:!0,offset_x:null,offset_y:null,visible:!0,modalId:"",onClose:function(){},onOpen:function(){},onContentLoaded:function(){this.fitToContent(!1)},destroy:!0},modal:!1,classSuffix:"",expanded:!1,initialize:function(a){this.options=jQuery.extend(this.options,a),this.makeWindow()},watchTabs:function(){var a=this;jQuery(".nav-tabs a").on("mouseup",function(){a.fitToWidth(),a.drawWindow()})},deleteButton:function(){return jQuery(Fabrik.jLayouts["modal-close"])[0]},contentHeight:function(){var a=this.window.find(".contentWrapper");return a.css("height","auto"),a[0].getDimensions(!0).height},center:function(){var a=this.windowDimensionInPx("width"),b=this.windowDimensionInPx("height"),c=this.window.width(),d=this.window.height(),e={};if(c=null===c||"auto"===c?a:c,d=null===d||"auto"===d?b:d,c=parseInt(c,10),d=parseInt(d,10),this.modal){var f=(window.getSize().y-d)/2,g=(window.getSize().x-c)/2;e.top=0>f?window.getScroll().y:window.getScroll().y+f,e.left=0>g?window.getScroll().x:window.getScroll().x+g}else{var h=window.getSize().y/2+window.getScroll().y-d/2;e.top=null!==this.options.offset_y?window.getScroll().y+this.options.offset_y:h;var i=window.getSize().x/2+window.getScroll().x-c/2;e.left=null!==this.options.offset_x?window.getScroll().x+this.options.offset_x:i}e["margin-left"]=0,this.window.css(e)},windowDimensionInPx:function(a){var b="height"===a?"y":"x",c=this.options[a]+"";return-1!==c.indexOf("%")?Math.floor(window.getSize()[b]*(c.toFloat()/100)):parseInt(c,10)},makeWindow:function(){var a,b,c=this;Fabrik.jLayouts[this.options.modalId]?(this.window=this.buildWinFromLayout(),this.window.find('*[data-role="title"]').text(this.options.title)):this.window=this.buildWinViaJS(),jQuery(document.body).append(this.window),this.loadContent(),this.options.visible||this.window.fade("hide"),jQuery(this.window).find('*[data-role="close"]').on("click",function(a){a.preventDefault(),c.close()}),this.window.find('*[data-role="expand"]').on("click",function(a){a.preventDefault(),c.expand()}),a=this.windowDimensionInPx("width"),b=this.contentHeight(),this.contentWrapperEl.css({height:b,width:a+"px"});var d=this.window.find('*[data-role="title"]');this.modal||(this.window.draggable({handle:d,drag:function(){Fabrik.fireEvent("fabrik.window.resized",this.window),c.drawWindow()}}),this.window.resizable({containment:this.options.container?jQuery("#"+this.options.container):null,handles:{n:".ui-resizable-n",e:".ui-resizable-e",s:".ui-resizable-s",w:".ui-resizable-w",ne:".ui-resizable-ne",se:".ui-resizable-se",sw:".ui-resizable-sw",nw:".ui-resizable-nw"},resize:function(){c.drawWindow()}})),this.window.css("width",this.options.width),this.window.css("height",this.options.height+this.window.find('*[data-role="title"]').height()),this.modal?this.fitToContent(!1):this.center()},buildWinFromLayout:function(){var a=jQuery(Fabrik.jLayouts[this.options.modalId]);return this.contentEl=a.find(".itemContentPadder"),this.contentWrapperEl=a.find("div.contentWrapper"),a},buildWinViaJS:function(){var a,b,c,d,e,f,g=[];this.window=new Element("div",{id:this.options.id,"class":"fabrikWindow "+this.classSuffix+" modal"});var h=this.deleteButton(),i="handlelabel";this.modal||(i+=" draggable",a=jQuery("<div />").addClass("bottomBar modal-footer"),b=jQuery("<div />").addClass("dragger"),e=jQuery(Fabrik.jLayouts["icon-expand"]),e.prependTo(b),a.append(b)),d=jQuery(Fabrik.jLayouts["icon-full-screen"]),f=jQuery("<h3 />").addClass(i).text(this.options.title),g.push(f),this.options.expandable&&this.modal===!1&&(c=jQuery("<a />").addClass("expand").attr({href:"#"}).append(d),g.push(c)),g.push(h),this.handle=this.getHandle().append(g);var j=15,k=15,l=this.options.height-j-k;l<this.options.loadHeight&&(l=this.options.loadHeight),this.contentWrapperEl=jQuery("<div />").addClass("contentWrapper").css({height:l+"px"});var m=jQuery("<div />").addClass("itemContent");return this.contentEl=jQuery("<div />").addClass("itemContentPadder"),m.append(this.contentEl),this.contentWrapperEl.append(m),this.window=jQuery(this.window),this.window.append(this.modal?[this.handle,this.contentWrapperEl]:[this.handle,this.contentWrapperEl,a]),this.window},expand:function(){if(this.expanded)this.window.css({left:this.unexpanded.left+"px",top:this.unexpanded.top+"px"}),this.window.css({width:this.unexpanded.width,height:this.unexpanded.height}),this.expanded=!1;else{this.expanded=!0;var a=window.getSize();this.unexpanded=jQuery.extend({},this.window.position(),{width:this.window.width(),height:this.window.height()});var b=window.getScroll();this.window.css({left:b.x+"px",top:b.y+"px"}),this.window.css({width:a.x,height:a.y})}this.drawWindow()},getHandle:function(){var a=this.handleClass();return jQuery("<div />").addClass("draggable "+a)},handleClass:function(){return"modal-header"},loadContent:function(){var a,b=this;switch(window.fireEvent("tips.hideall"),this.options.loadMethod){case"html":if(void 0===this.options.content)return fconsole("no content option set for window.html"),void this.close();"element"===typeOf(this.options.content)?this.options.content.inject(this.contentEl.empty()):this.contentEl.html(this.options.content),this.options.onContentLoaded.apply(this),this.watchTabs();break;case"xhr":b.window.width(b.options.width),b.window.height(b.options.height),Fabrik.loader.start(b.contentEl),new jQuery.ajax({url:this.options.contentURL,data:{fabrik_window_id:this.options.id},method:"post"}).success(function(a){Fabrik.loader.stop(b.contentEl),b.contentEl.append(a),b.watchTabs(),b.center(),b.options.onContentLoaded.apply(b)});break;case"iframe":var c=this.options.height-40,d=this.contentEl[0].scrollWidth,e=d+40<jQuery(window).width()?d+40:jQuery(window).width();a=this.window.getElement(".itemContent"),Fabrik.loader.start(a),this.iframeEl&&this.iframeEl.remove(),this.iframeEl=jQuery("<iframe />").addClass("fabrikWindowIframe").attr({id:this.options.id+"_iframe",name:this.options.id+"_iframe","class":"fabrikWindowIframe",src:this.options.contentURL,marginwidth:0,marginheight:0,frameBorder:0,scrolling:"auto"}).css({height:c+"px",width:e}).inject(this.window.find(".itemContent")),this.iframeEl.hide(),this.iframeEl.on("load",function(){Fabrik.loader.stop(b.window.find(".itemContent")),b.iframeEl.show(),b.trigger("onContentLoaded",[b]),b.watchTabs()})}},titleHeight:function(){var a=this.window.find("."+this.handleClass());return a.length>0?a.outerHeight():25},footerHeight:function(){return parseInt(this.window.find(".bottomBar").outerHeight(),10)},drawWindow:function(){var a=this.titleHeight(),b=this.footerHeight(),c=this.contentHeight(),d=this.window.width();c>this.window.height()&&(c=this.window.height()-a-b),this.contentWrapperEl.css("height",c),this.contentWrapperEl.css("width",d-2),"iframe"===this.options.loadMethod&&(this.iframeEl.css("height",this.contentWrapperEl[0].offsetHeight-40),this.iframeEl.css("width",this.contentWrapperEl[0].offsetWidth-10))},fitToContent:function(a,b){a=void 0===a?!0:a,b=void 0===b?!0:b,"iframe"!==this.options.loadMethod&&(this.fitToHeight(),this.fitToWidth()),this.drawWindow(),b&&this.center(),!this.options.offset_y&&a&&jQuery("body").scrollTop(this.window)},fitToHeight:function(){var a=this.contentHeight()+this.footerHeight()+this.titleHeight(),b=jQuery(window).height(),c=b>a?a:b;this.window.css("height",c)},fitToWidth:function(){var a=this.window.find(".itemContent"),b=jQuery(window).width(),c=a[0].scrollWidth,d=b>c+25?c+25:b;this.window.css("width",d)},close:function(){this.options.destroy?(this.window.remove(),delete Fabrik.Windows[this.options.id]):this.window.fadeOut({duration:0}),this.fireEvent("onClose",[this])},open:function(a){a&&a.stopPropagation(),this.window.fadeIn({duration:0}),this.fireEvent("onOpen",[this])}}),Fabrik.Modal=new Class({Extends:Fabrik.Window,modal:!0,classSuffix:"fabrikWindow-modal",getHandle:function(){return jQuery("<div />").addClass(this.handleClass())},drawWindow:function(){var a=this.titleHeight(),b=this.footerHeight(),c=this.options.height,d=this.options.width;c>this.window.height()&&(c=this.window.height()-a-b),this.contentWrapperEl.css("height",c),this.contentWrapperEl.css("width",d-2),"iframe"===this.options.loadMethod&&(this.iframeEl.css("height",this.contentWrapperEl[0].offsetHeight-40),this.iframeEl.css("width",this.contentWrapperEl[0].offsetWidth-10))},fitToHeight:function(){this.window.css("height",this.options.height)},fitToWidth:function(){this.window.css("width",this.options.width)}}),Fabrik.RedirectWindow=new Class({Extends:Fabrik.Window,initialize:function(a){var b={id:"redirect",title:a.title?a.title:"",loadMethod:c,width:a.width?a.width:300,height:a.height?a.height:320,minimizable:!1,collapsible:!0};b.id="redirect",a=jQuery.merge(b,a);var c,d=a.contentURL;a.loadMethod="xhr",d.contains(Fabrik.liveSite)||!d.contains("http://")&&!d.contains("https://")?d.contains("tmpl=component")||(a.contentURL+=d.contains("?")?"&tmpl=component":"?tmpl=component"):a.loadMethod="iframe",this.options=jQuery.extend(this.options,a),this.makeWindow()}});