/*! Fabrik */

define(["jquery","fab/loader","fab/requestqueue"],function(u,e,t){var o=u(document);document.addEvent("click:relay(.popover button.close)",function(e,t){var o="#"+t.get("data-popover"),n=document.getElement(o);u(o).popover("hide"),"null"!==typeOf(n)&&"input"===n.get("tag")&&(n.checked=!1)});var f={events:{},bootstrapVersion:function(e){var t,o=[e||"modal","tooltip"],n=o.length;for(t=0;t<n;++t){var i=u.fn[o[t]];if(i){if(i.VERSION)return i.VERSION.match(/(\d+)\./)[0].toInt();if(i.Constructor&&i.Constructor.VERSION)return i.Constructor.VERSION.match(/(\d+)\./)[0].toInt()}}return 2},Windows:{}};return f.loader=new e,f.blocks={},f.periodicals={},f.addBlock=function(e,t){f.blocks[e]=t,f.fireEvent("fabrik.block.added",[t,e])},f.getBlock=function(e,t,o){return(o=o||!1)&&(f.periodicals[e]=f._getBlock.periodical(500,this,[e,t,o])),f._getBlock(e,t,o)},f._getBlock=function(e,t,o){var n;if(t=t||!1,void 0!==f.blocks[e])n=e;else{if(t)return!1;var i=Object.keys(f.blocks),a=i.searchFor(e);if(-1===a)return!1;n=i[a]}return o&&(clearInterval(f.periodicals[e]),o(f.blocks[n])),f.blocks[n]},o.on("click",".fabrik_delete a, .fabrik_action a.delete, .btn.delete",function(e){e.rightClick||f.watchDelete(e,this)}),o.on("click",".fabrik_edit a, a.fabrik_edit",function(e){e.rightClick||f.watchEdit(e,this)}),o.on("click",".fabrik_view a, a.fabrik_view",function(e){e.rightClick||f.watchView(e,this)}),document.addEvent("click:relay(*[data-fabrik-view])",function(e,t){if(!e.rightClick){var o,n,i;e.preventDefault(),o=(n="a"===e.target.get("tag")?e.target:"null"!==typeOf(e.target.getElement("a"))?e.target.getElement("a"):e.target.getParent("a")).get("href"),o+=o.contains("?")?"&tmpl=component&ajax=1":"?tmpl=component&ajax=1",o+="&format=partial",$H(f.Windows).each(function(e,t){e.close()}),(i=n.get("title"))||(i=Joomla.JText._("COM_FABRIK_VIEW"));var a={id:"view."+o,title:i,loadMethod:"xhr",contentURL:o};f.getWindow(a)}}),f.removeEvent=function(e,t){if(f.events[e]){var o=f.events[e].indexOf(t);-1!==o&&delete f.events[e][o]}},f.addEvent=f.on=function(e,t){f.events[e]||(f.events[e]=[]),f.events[e].contains(t)||f.events[e].push(t)},f.addEvents=function(e){var t;for(t in e)e.hasOwnProperty(t)&&f.addEvent(t,e[t]);return this},f.fireEvent=f.trigger=function(e,t,o){var n=f.events;return this.eventResults=[],n&&n[e]&&(t=Array.from(t),n[e].each(function(e){o?this.eventResults.push(e.delay(o,this,t)):this.eventResults.push(e.apply(this,t))},this)),this},f.requestQueue=new t,f.cbQueue={google:[]},f.loadGoogleMap=function(e,t){var o=("https:"===document.location.protocol?"https:":"http:")+"//maps.googleapis.com/maps/api/js?libraries=places,visualization&callback=Fabrik.mapCb";if(!1!==e&&(o+="&key="+e),0===Array.from(document.scripts).filter(function(e){return e.src===o}).length){var n=document.createElement("script");n.type="text/javascript",n.src=o,document.body.appendChild(n),f.cbQueue.google.push(t)}else f.googleMap?window[t]():f.cbQueue.google.push(t)},f.mapCb=function(){var e,t;for(f.googleMap=!0,t=0;t<f.cbQueue.google.length;t++)e=f.cbQueue.google[t],"function"===typeOf(e)?e():window[e]();f.cbQueue.google=[]},f.watchDelete=function(e,t){var o,n,i;if((i=e.target.getParent(".fabrik_row"))||(i=f.activeRow),i){var a=i.getElement("input[type=checkbox][name*=id]");"null"!==typeOf(a)&&(a.checked=!0),n=(n=i.id.split("_")).splice(0,n.length-2).join("_"),o=f.blocks[n]}else if(n=e.target.getParent(".fabrikList"),"null"!==typeOf(n))n=n.id,o=f.blocks[n];else{var r=t.getParent(".floating-tip-wrapper");if(r)n=r.retrieve("list").id;else n=t.get("data-listRef");void 0===(o=f.blocks[n])||"floating"!==o.options.actionMethod||this.bootstrapped||o.form.getElements("input[type=checkbox][name*=id], input[type=checkbox][name=checkAll]").each(function(e){e.checked=!0})}o.submit("list.delete")||e.preventDefault()},f.watchEdit=function(e,t){f.openSingleView("form",e,t)},f.watchView=function(e,t){f.openSingleView("details",e,t)},f.openSingleView=function(o,e,t){var n,i,a,r,l,c,s,p=u(t).data("list"),d=f.blocks[p];if(1===u(t).data("isajax")){if(d){if(!d.options.ajax_links)return;if(!(c=d.getActiveRow(e))||0===c.length)return;d.setActive(c),l=c.prop("id").split("_").pop()}else l=u(t).data("rowid");e.preventDefault(),n=(a="A"===u(e.target).prop("tagName")?u(e.target):0<u(e.target).find("a").length?u(e.target).find("a"):u(e.target).closest("a")).prop("href"),1!==u(t).data("iscustom")&&(n+=n.contains("?")?"&tmpl=component&ajax=1":"?tmpl=component&ajax=1",n+="&format=partial"),r=a.prop("title"),void 0===(i=a.data("loadmethod"))&&(i="xhr"),u.each(f.Windows,function(e,t){t.close()}),s={modalId:"ajax_links",id:p+"."+l,title:r,loadMethod:i,contentURL:n,onClose:function(){var e=o+"_"+d.options.formid+"_"+l;try{f.blocks[e].destroyElements(),f.blocks[e].formElements=null,f.blocks[e]=null,delete f.blocks[e];var t="details"===o?"fabrik.list.row.view.close":"fabrik.list.row.edit.close";f.fireEvent(t,[p,l,e])}catch(e){console.log(e)}}},d&&(""!==d.options.popup_width&&(s.width=d.options.popup_width),""!==d.options.popup_height&&(s.height=d.options.popup_height),s.id="details"===o?"view."+s.id:"add."+s.id,null!==d.options.popup_offset_x&&(s.offset_x=d.options.popup_offset_x),null!==d.options.popup_offset_y&&(s.offset_y=d.options.popup_offset_y)),f.getWindow(s)}},f.calSelect=function(){if(event.target.calendar){var e=u(event.target.calendar.inputField).closest("form");if(0<e.length&&(e=f.getBlock(e[0].id))){var t=u(event.target.calendar.inputField).closest(".fabrikSubElementContainer");0<t.length&&(t=e.formElements.get(t[0].id))&&t.calSelect(event.target.calendar)}}},f.Array={chunk:function(e,t){var o,n,i=[];for(o=0,n=e.length;o<n;o+=t)i.push(e.slice(o,o+t));return i}},window.fireEvent("fabrik.loaded"),window.Fabrik=f});