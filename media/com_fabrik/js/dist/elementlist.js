/*! Fabrik */
define(["jquery","fab/element"],function(jQuery,FbElement){return window.FbElementList=new Class({Extends:FbElement,type:"text",initialize:function(a,b){this.parent(a,b),this.addSubClickEvents(),this._getSubElements(),this.options.allowadd===!0&&this.options.editable!==!1&&(this.watchAddToggle(),this.watchAdd())},_getSubElements:function(){var a=this.getElement();return this.subElements=a?a.getElements("input[type="+this.type+"]"):[],this.subElements},addSubClickEvents:function(){this._getSubElements().each(function(a){a.addEvent("click",function(a){Fabrik.fireEvent("fabrik.element.click",[this,a])})})},eventDelegate:function(){return"input[type="+this.type+"][name^="+this.options.fullName+"]"},checkEventAction:function(a){return a},addNewEvent:function(action,js){var r,delegate,uid,c;action=this.checkEventAction(action),"load"===action?(this.loadEvents.push(js),this.runLoadEvent(js)):(c=this.form.form,delegate=this.eventDelegate(),"null"===typeOf(this.form.events[action])&&(this.form.events[action]={}),"function"==typeof js?uid=1e3*Math.random(100):(r=new RegExp("[^a-z|0-9]","gi"),uid=delegate+js.replace(r,"")),"null"===typeOf(this.form.events[action][uid])&&(this.form.events[action][uid]=!0,jQuery(c).on(action,delegate,function(event){event.stopPropagation();var target=jQuery(event.currentTarget),elid,that,subEls;"LABEL"===target.prop("tagName")&&(target=target.find("input")),elid=target.closest(".fabrikSubElementContainer").prop("id"),that=this.form.formElements[elid],subEls=that._getSubElements(),target.length>0&&subEls.contains(target[0])&&("function"!=typeof js?(js=js.replace(/this/g,"that"),eval(js)):js.delay(0))}.bind(this))))},checkEnter:function(a){"enter"===a.key&&(a.stop(),this.startAddNewOption())},startAddNewOption:function(){var a,b,c,d,e=jQuery(this.getContainer()),f=e.find("input[name=addPicklistLabel]"),g=e.find("input[name=addPicklistValue]"),h=f.val();if(a=g.length>0?g.val():h,""===a||""===h)window.alert(Joomla.JText._("PLG_ELEMENT_CHECKBOX_ENTER_VALUE_LABEL"));else{if(d=jQuery(this.subElements[this.subElements.length-1]).closest("fabrikgrid_"+this.type),b=jQuery(d).clone(),c=b.find("input"),c.val(a),c.prop("checked","checked"),"checkbox"===this.type){var i=c.prop("name").replace(/^(.*)\[.*\](.*?)$/,"$1$2");c.name=i+"["+this.subElements.length+"]"}b.find("."+this.type+" span").text(h),b.after(d);var j=0;"radio"===this.type&&(j=this.subElements.length);var k=jQuery("input[name="+c.name+"]");jQuery(this.form.form).trigger("change",{target:k[j]}),this._getSubElements(),g&&(g.value=""),f.value="",this.addNewOption(a,h),this.mySlider&&this.mySlider.toggle()}},watchAdd:function(){var a=this,b=jQuery(this.getContainer());this.options.allowadd===!0&&this.options.editable!==!1&&(b.find("input[name=addPicklistLabel], input[name=addPicklistValue]").on("keypress",function(b){a.checkEnter(b)}),b.find("input[type=button]").on("click",function(b){b.preventDefault(),a.startAddNewOption()}),jQuery(document).on("keypress",function(b){"esc"===b.key&&this.mySlider&&a.mySlider.slideUp()}))}}),window.FbElementList});