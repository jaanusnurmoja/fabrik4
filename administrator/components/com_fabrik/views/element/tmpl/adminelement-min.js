/*! Fabrik */
define(["jquery","admin/pluginmanager"],function(i,e){return new Class({Extends:e,Implements:[Options,Events],options:{id:0,parentid:0,jsevents:[],jsTotal:0,deleteButton:"removeButton"},jsCounter:-1,jsAjaxed:0,initialize:function(e,t,n){Fabrik.debug&&fconsole("Fabrik adminelement.js: Initialising",e,t,n),this.parent(e,n,"validationrule"),this.setOptions(t),this.setParentViz(),this.jsAccordion=new Fx.Accordion([],[],{alwaysHide:!0,display:-1,duration:"short"}),window.addEvent("domready",function(){"null"===typeOf(document.id("addJavascript"))?fconsole("Fabrik adminelement.js: javascript tab Add button not found"):document.id("addJavascript").addEvent("click",function(e){e.stop(),this.jsAccordion.display(-1),this.addJavascript()}.bind(this)),this.watchLabel(),this.watchGroup(),this.options.jsevents.each(function(e){this.addJavascript(e)}.bind(this)),this.jsPeriodical=this.iniJsAccordion.periodical(250,this),document.id("jform_plugin").addEvent("change",function(e){this.changePlugin(e.target.get("value"))}.bind(this)),""===document.getElement("input[name=name_orig]").value&&this.changePlugin("field"),document.id("javascriptActions").addEvent("click:relay(a[data-button=removeButton])",function(e,t){e.stop(),this.deleteJS(t)}.bind(this)),document.id("javascriptActions").addEvent('change:relay(select[id^="jform_action-"],select[id^="jform_js_e_event-"],select[id^="jform_js_e_trigger-"],select[id^="jform_js_e_condition-"],input[id^="jform_js_e_value-"])',function(e,t){this.setAccordionHeader(t.getParent(".actionContainer"))}.bind(this));var e=document.id("plugins");"null"!==typeOf(e)&&e.addEvent("click:relay(h3.title)",function(e,t){document.id("plugins").getElements("h3.title").each(function(e){e!==t&&e.removeClass("pane-toggler-down")}),t.toggleClass("pane-toggler-down")})}.bind(this))},watchLabel:function(){this.autoChangeDbName=""===i("#jform_name").val(),i("#jform_label").on("keyup",function(e){var t;this.autoChangeDbName&&(t=(t=i("#jform_label").val().trim().toLowerCase()).replace(/\W+/g,"_"),i("#jform_name").val(t))}.bind(this)),i("#jform_name").on("keyup",function(){this.autoChangeDbName=!1}.bind(this))},watchGroup:function(){var e,n="fabrik_element_group";""===i("#jform_group_id").val()&&(e=(e=document.cookie.match("(^|;) ?"+n+"=([^;]*)(;|$)"))?e[2]:null,i("#jform_group_id").val(e)),i("#jform_group_id").on("change",function(){var e=i("#jform_group_id").val(),t=new Date,t=(t.setTime(t.getTime()+864e5),"; expires="+t.toGMTString());document.cookie=n+"="+encodeURIComponent(e)+t})},iniJsAccordion:function(){this.jsAjaxed===this.options.jsevents.length&&(1===this.options.jsevents.length?this.jsAccordion.display(0):this.jsAccordion.display(-1),clearInterval(this.jsPeriodical))},changePlugin:function(e){document.id("plugin-container").empty().adopt(new Element("span").set("text",Joomla.JText._("COM_FABRIK_LOADING")));e=new Request({url:"index.php",evalResponse:!1,evalScripts:function(e,t){this.script=e}.bind(this),data:{option:"com_fabrik",id:this.options.id,task:"element.getPluginHTML",format:"raw",plugin:e},update:document.id("plugin-container"),onComplete:function(e){document.id("plugin-container").set("html",e),Browser.exec(this.script),this.updateBootStrap(),FabrikAdmin.reTip()}.bind(this)});Fabrik.requestQueue.add(e)},deleteJS:function(e){e=e.getParent("div.actionContainer");Fabrik.debug&&fconsole("Fabrik adminelement.js: Deleting JS entry: ",e.id),e.dispose(),this.jsAjaxed--},addJavascript:function(e){var e=e&&e.id?e.id:0,t=new Element("div.actionContainer.panel.accordion-group"),n=new Element("a.accordion-toggle",{href:"#"}),n=(n.adopt(new Element("span.pluginTitle").set("text",Joomla.JText._("COM_FABRIK_LOADING"))),new Element("div.title.pane-toggler.accordion-heading").adopt(new Element("strong").adopt(n))),i=new Element("div.accordion-body"),o=(t.adopt(n),t.adopt(i),this.jsAccordion.addSection(n,i),t.inject(document.id("javascriptActions")),this.jsCounter),n=new Request.HTML({url:"index.php",data:{option:"com_fabrik",view:"plugin",task:"top",format:"raw",type:"elementjavascript",plugin:null,plugin_published:!0,c:o,id:e,elementid:this.id},update:i,onRequest:function(){Fabrik.debug&&fconsole("Fabrik adminelement.js: Adding JS entry",(o+1).toString())},onComplete:function(e){i.getElement('textarea[id^="jform_code-"]').addEvent("change",function(e,t){this.setAccordionHeader(e.target.getParent(".actionContainer"))}.bind(this)),this.setAccordionHeader(t),this.jsAjaxed++,this.updateBootStrap(),FabrikAdmin.reTip()}.bind(this),onFailure:function(e){fconsole("Fabrik adminelement.js addJavascript: ajax failure: ",e)},onException:function(e,t){fconsole("Fabrik adminelement.js addJavascript: ajax exception: ",e,t)}});this.jsCounter++,Fabrik.requestQueue.add(n),this.updateBootStrap(),FabrikAdmin.reTip()},setAccordionHeader:function(e){var t,n,i,o,a,d,s,r,l;"null"!==typeOf(e)&&(t=e.getElement("span.pluginTitle"),""===(n=e.getElement('select[id^="jform_action-"]')).value?t.set("html",'<span style="color:red;">'+Joomla.JText._("COM_FABRIK_JS_SELECT_EVENT")+"</span>"):(n="on "+n.getSelected()[0].text+" : ",i=e.getElement('textarea[id^="jform_code-"]'),o=e.getElement('select[id^="jform_js_e_event-"]'),a=e.getElement('select[id^="jform_js_e_trigger-"]'),d=document.id("jform_name"),s=e.getElement('input[id^="jform_js_e_value-"]'),e=e.getElement('select[id^="jform_js_e_condition-"]'),(r="")!==i.value.clean()?(r=(l=i.value.split("\n")[0].trim().match(/^\/\*(.*)\*\//))?l[1]:Joomla.JText._("COM_FABRIK_JS_INLINE_JS_CODE"),i.value.replace(/(['"]).*?[^\\]\1/g,"").test("//")&&(r=(r+=' &nbsp; <span style="color:red;font-weight:bold;">')+Joomla.JText._("COM_FABRIK_JS_INLINE_COMMENT_WARNING").replace(/ /g,"&nbsp;")+"</span>")):o.value&&a.value&&d.value?(r=Joomla.JText._("COM_FABRIK_JS_WHEN_ELEMENT")+' "'+d.value+'" ',e.getSelected()[0].text.test(/hidden|shown/)?r=(r+=Joomla.JText._("COM_FABRIK_JS_IS")+" ")+e.getSelected()[0].text+", ":r+=e.getSelected()[0].text+' "'+s.value.trim()+'", ',l=a.getSelected().getParent("optgroup").get("label")[0].toLowerCase(),r=(r+=o.getSelected()[0].text+" "+l.substring(0,l.length-1))+' "'+a.getSelected()[0].text+'"'):n+='<span style="color:red;">'+Joomla.JText._("COM_FABRIK_JS_NO_ACTION")+"</span>",""!==r&&(n+='<span style="font-weight:normal">'+r+"</span>"),t.set("html",n)))},setParentViz:function(){var t;0!==this.options.parentid.toInt()&&(t=new Fx.Tween("elementFormTable",{property:"opacity",duration:500,wait:!1}).set(0),document.id("unlink").addEvent("click",function(e){this.checked?t.start(0,1):t.start(1,0)})),document.id("swapToParent")&&document.id("swapToParent").addEvent("click",function(e){var t=document.adminForm,e=(t.task.value="element.parentredirect",e.target.className.replace("element_",""));t.redirectto.value=e,t.submit()})}})});