define(["jquery"],function(jQuery){var ListForm;return new Class({autoChangeDbName:!0,Implements:[Options],initialize:function(a){var b;window.addEvent("domready",(function(){this.setOptions(a),this.watchTableDd(),this.watchLabel(),document.id("addAJoin")&&document.id("addAJoin").addEvent("click",(function(a){a.stop(),this.addJoin()}).bind(this)),document.getElement("table.linkedLists")&&(b=document.getElement("table.linkedLists").getElement("tbody"),new Sortables(b,{handle:".handle",onSort:function(c,d){var a=this.serialize(1,function(a){return a.getElement("input")?a.getElement("input").name.split("][").getLast().replace("]",""):""}),b=[];a.each(function(a){""!==a&&b.push(a)}),document.getElement("input[name*=faceted_list_order]").value=JSON.stringify(b)}})),document.getElement("table.linkedForms")&&(b=document.getElement("table.linkedForms").getElement("tbody"),new Sortables(b,{handle:".handle",onSort:function(c,d){var a=this.serialize(1,function(a){return a.getElement("input")?a.getElement("input").name.split("][").getLast().replace("]",""):""}),b=[];a.each(function(a){""!==a&&b.push(a)}),document.getElement("input[name*=faceted_form_order]").value=JSON.stringify(b)}})),this.joinCounter=0,this.watchOrderButtons(),this.watchDbName(),this.watchJoins()}).bind(this))},watchLabel:function(){this.autoChangeDbName=""===jQuery("#jform__database_name").val(),jQuery("#jform_label").on("keyup",(function(b){if(this.autoChangeDbName){var a=jQuery("#jform_label").val().trim().toLowerCase();a=a.replace(/\W+/g,"_"),jQuery("#jform__database_name").val(a)}}).bind(this)),jQuery("#jform__database_name").on("keyup",(function(){this.autoChangeDbName=!1}).bind(this))},watchOrderButtons:function(){document.getElements(".addOrder").removeEvents("click"),document.getElements(".deleteOrder").removeEvents("click"),document.getElements(".addOrder").addEvent("click",(function(a){a.stop(),this.addOrderBy()}).bind(this)),document.getElements(".deleteOrder").addEvent("click",(function(a){a.stop(),this.deleteOrderBy(a)}).bind(this))},addOrderBy:function(a){var b;(b=a?a.target.getParent(".orderby_container"):document.getElement(".orderby_container")).clone().inject(b,"after"),this.watchOrderButtons()},deleteOrderBy:function(a){document.getElements(".orderby_container").length>1&&(a.target.getParent(".orderby_container").dispose(),this.watchOrderButtons())},watchDbName:function(){document.id("database_name")&&document.id("database_name").addEvent("blur",function(a){""===document.id("database_name").get("value")?document.id("tablename").disabled=!1:document.id("tablename").disabled=!0})},_buildOptions:function(a,c){var b=[];return a.length>0&&("object"==typeof a[0]?a.each(function(a){a[0]===c?b.push(new Element("option",{value:a[0],selected:"selected"}).set("text",a[1])):b.push(new Element("option",{value:a[0]}).set("text",a[1]))}):a.each(function(a){a===c?b.push(new Element("option",{value:a,selected:"selected"}).set("text",a)):b.push(new Element("option",{value:a}).set("text",a))})),b},watchTableDd:function(){document.id("tablename")&&document.id("tablename").addEvent("change",function(e){var cid=document.getElement("input[name*=connection_id]").get("value"),table=document.id("tablename").get("value"),url="index.php?option=com_fabrik&format=raw&task=list.ajax_updateColumDropDowns&cid="+cid+"&table="+table,myAjax=new Request({url:url,method:"post",onComplete:function(r){eval(r)}}).send()})},watchFieldList:function(a){document.getElement("div[id^=table-sliders-data]").addEvent("change:relay(select[name*="+a+"])",(function(b,a){this.updateJoinStatement(a.getParent("tr").id.replace("join",""))}).bind(this))},_findActiveTables:function(){document.getElements(".join_from").combine(document.getElements(".join_to")).each((function(b){var a=b.get("value");-1===this.options.activetableOpts.indexOf(a)&&this.options.activetableOpts.push(a)}).bind(this)),this.options.activetableOpts.sort()},addJoin:function(a,d,b,e,f,c,g,h,i,j){b=b||"left",g=g||"",e=e||"",f=f||"",c=c||"",a=a||"",d=d||"",(j=!!j&&j)?(n='checked="checked"',o=""):(o='checked="checked"',n=""),this._findActiveTables(),h=h||[["-",""]],i=i||[["-",""]];var n,o,l,k,p=new Element("tbody"),q=new Element("input",{readonly:"readonly",size:"2",class:"disabled readonly input-mini",name:"jform[params][join_id][]",value:d}),m=new Element("a",{href:"#",class:"btn btn-danger btn-sm",events:{click:(function(a){return this.deleteJoin(a),!1}).bind(this)}}),r='<i class="icon-minus"></i> ';m.set("html",r),b=new Element("select",{name:"jform[params][join_type][]",class:"form-select-sm inputbox"}).adopt(this._buildOptions(this.options.joinOpts,b));var s=new Element("select",{name:"jform[params][join_from_table][]",class:"form-select-sm join_from inputbox"}).adopt(this._buildOptions(this.options.activetableOpts,g));a=new Element("input",{type:"hidden",name:"group_id[]",value:a});var t=new Element("select",{name:"jform[params][table_join][]",class:"form-select-sm join_to inputbox"}).adopt(this._buildOptions(this.options.tableOpts,e)),u=new Element("select",{name:"jform[params][table_key][]",class:"table_key inputbox form-select-sm"}).adopt(this._buildOptions(h,f));c=new Element("select",{name:"jform[params][table_join_key][]",class:"table_join_key inputbox form-select-sm"}).adopt(this._buildOptions(i,c));var v='<fieldset class="radio"><input type="radio" id="joinrepeatno'+this.joinCounter+'" value="0" name="jform[params][join_repeat]['+this.joinCounter+'][]" '+o+'/><label style="padding: 0.1rem 0.6rem 0.1rem 0.2rem" for="joinrepeatno'+this.joinCounter+'">'+Joomla.JText._("JNO")+'</label><input type="radio" id="joinrepeat'+this.joinCounter+'" value="1" name="jform[params][join_repeat]['+this.joinCounter+'][]" '+n+'/><label style="padding: 0.1rem 0.6rem 0.1rem 0.2rem" for="joinrepeat'+this.joinCounter+'">'+Joomla.JText._("JYES")+"</label></fieldset>";l=new Element("thead").adopt(new Element("tr").adopt([new Element("th").set("text","id"),new Element("th").set("text",Joomla.JText._("COM_FABRIK_JOIN_TYPE")),new Element("th").set("text",Joomla.JText._("COM_FABRIK_FROM")),new Element("th").set("text",Joomla.JText._("COM_FABRIK_TO")),new Element("th").set("text",Joomla.JText._("COM_FABRIK_FROM_COLUMN")),new Element("th").set("text",Joomla.JText._("COM_FABRIK_TO_COLUMN")),new Element("th").set("text",Joomla.JText._("COM_FABRIK_REPEAT_GROUP_BUTTON_LABEL")),new Element("th")])),k=new Element("tr",{id:"join"+this.joinCounter}).adopt([new Element("td").adopt(q),new Element("td").adopt([a,b]),new Element("td").adopt(s),new Element("td").adopt(t),new Element("td.table_key").adopt(u),new Element("td.table_join_key").adopt(c),new Element("td").set("html",v),new Element("td").adopt(m)]);var w="",x=new Element("table",{class:"table-striped table",id:w}).adopt([l,p.adopt(k)]);if(0===this.joinCounter)x.inject(document.id("joindtd"));else{var y=document.id("joindtd").getElement("tbody");k.inject(y)}this.joinCounter++},deleteJoin:function(a){var b,c;a.stop(),c=a.target.getParent("tr"),b=a.target.getParent("table"),c.dispose(),0===b.getElements("tbody tr").length&&b.dispose()},watchJoins:function(){document.getElement("div[id^=table-sliders-data]").addEvent("change:relay(.join_from)",(function(h,a){var b=a.getParent("tr"),c=b.id.replace("join","");this.updateJoinStatement(c);var d=a.get("value"),e=document.getElement("input[name*=connection_id]").get("value"),f=b.getElement("td.table_key"),g="index.php?option=com_fabrik&format=raw&task=list.ajax_loadTableDropDown&table="+d+"&conn="+e;new Request.HTML({url:g,method:"post",update:f}).send()}).bind(this)),document.getElement("div[id^=table-sliders-data]").addEvent("change:relay(.join_to)",(function(f,a){var b=a.getParent("tr"),c=b.id.replace("join","");this.updateJoinStatement(c);var d="index.php?name=jform[params][table_join_key][]&option=com_fabrik&format=raw&task=list.ajax_loadTableDropDown&table="+a.get("value")+"&conn="+document.getElement("input[name*=connection_id]").get("value"),e=b.getElement("td.table_join_key");new Request.HTML({url:d,method:"post",update:e}).send()}).bind(this)),this.watchFieldList("join_type"),this.watchFieldList("table_join_key"),this.watchFieldList("table_key")},updateJoinStatement:function(b){var a=document.getElements("#join"+b+" .inputbox"),e=(a=Array.mfrom(a))[0].get("value"),f=a[1].get("value"),c=a[2].get("value"),g=a[3].get("value"),h=a[4].get("value"),i=e+" JOIN "+c+" ON "+f+"."+g+" = "+c+"."+h,d=document.id("join-desc-"+b);"null"!==typeOf(d)&&d.set("html",i)}})})