define(["jquery","fab/fabrik"],function(t,e){return new Class({Implements:[Events],options:{observe:"",trigger:"",cnn:0,table:0,map:"",editOrig:!1,fillOnLoad:!1,confirm:!0,autofill_lookup_field:0,showNotFound:!1,notFoundMsg:""},initialize:function(o){var n=this;this.options=t.extend(this.options,o),this.attached=[],this.newAttach=[],this.setupDone=!1,this.setUp(e.getBlock("form_"+this.options.formid)),e.addEvent("fabrik.form.elements.added",function(t){n.setUp(t)})},getElement:function(t){var e,o=!1,n=this,i=this.form.formElements.get(this.options.observe),s=0;return i?this.attached.push(i.options.element):Object.keys(this.form.formElements).each(function(e){e.contains(n.options.observe)&&(o=n.form.formElements.get(e),n.attached.contains(o.options.element)||n.attached.push(o.options.element),("null"===typeOf(t)||t===s)&&(i=o),s++)}),i},doLookup:function(t){this.lookUp(t)},setUp:function(t){var e=this;if(!this.setupDone&&void 0!==t){try{this.form=t}catch(o){return}this.doLookupEvent=this.doLookup.bind(this);var n=!1,i=this.form.formElements.get(this.options.observe);if(i)this.attached.push(i.options.element),e.newAttach.push(i.options.element);else{var s=0;Object.keys(this.form.formElements).each(function(t){if(t.contains(e.options.observe)){n=e.form.formElements.get(t),e.attached.contains(n.options.element)||(e.attached.push(n.options.element),e.newAttach.push(n.options.element));var o=parseInt(n.getRepeatNum(),10);(isNaN(o)||o===s)&&(i=n),s++}})}if(this.element=i,""===this.options.trigger){if(this.element){var r=this.element.getBlurEvent();this.newAttach.each(function(t){e.form.formElements.get(t),e.form.dispatchEvent("",t,r,e.doLookupEvent),e.options.fillOnLoad&&e.form.dispatchEvent("",t,"load",e.doLookupEvent)})}else fconsole("autofill - couldnt find element to observe")}else this.form.dispatchEvent("",this.options.trigger,"click",this.doLookupEvent),this.options.fillOnLoad&&this.form.dispatchEvent("",this.options.trigger,"load",this.doLookupEvent);this.setupDone=!0,this.newAttach=[]}},lookUp:function(o){if(this.options.trigger||(this.element=o),!0!==this.options.confirm||window.confirm(Joomla.JText._("PLG_FORM_AUTOFILL_DO_UPDATE"))){e.loader.start("form_"+this.options.formid,Joomla.JText._("PLG_FORM_AUTOFILL_SEARCHING")),this.element||(this.element=this.getElement(0));var n=this.element.getValue(),i=this.options.formid,s=this.options.observe,r=this;t.ajax({url:"index.php",method:"post",dataType:"json",data:{option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"autofill",method:"onajax_getAutoFill",g:"form",v:n,formid:i,observe:s,cnn:this.options.cnn,table:this.options.table,map:this.options.map,autofill_lookup_field:this.options.autofill_lookup_field}}).always(function(){e.loader.stop("form_"+r.options.formid)}).fail(function(t,e,o){window.alert(e)}).done(function(t){r.updateForm(t)})}},updateForm:function(o){this.json=o,e.fireEvent("fabrik.form.autofill.update.start",[this,o]);var n,i,s,r,a=this.element.getRepeatNum();if(t.isEmptyObject(this.json)){if(this.options.showNotFound){var h=""===this.options.notFoundMsg?Joomla.JText._("PLG_FORM_AUTOFILL_NORECORDS_FOUND"):this.options.notFoundMsg;window.alert(h)}return}for(n in this.json)this.json.hasOwnProperty(n)&&(i=this.json[n],"_raw"!==n.substr(n.length-4,4)||(r=n=n.replace("_raw",""),this.tryUpdate(n,i)||(n=this.updateRepeats(n,i,a,r))));!0===this.options.editOrig&&(this.form.getForm().getElement("input[name=rowid]").value=this.json.__pk_val),e.fireEvent("fabrik.form.autofill.update.end",[this,o])},updateRepeats:function(t,e,o,n){var i,s;if("object"==typeof e)for(i in e)e.hasOwnProperty(i)&&(s=t+"_"+i,this.tryUpdate(s,e[i]));else t+=o?"_"+o:"_0",this.tryUpdate(t,e)||(t="join___"+this.element.options.joinid+"___"+t,this.tryUpdate(n,e,!0));return t},tryUpdate:function(t,e,o){var n,i,s=this;if(o=!!o){if((n=Object.keys(this.form.formElements).filter(function(e,o){return e.contains(t)})).length>0)return n.each(function(t){(i=s.form.elements[t]).update(e),i.baseElementId!==s.element.baseElementId&&(i.element.fireEvent(i.getBlurEvent(),new Event.Mock(i.element,i.getBlurEvent())),i.getBlurEvent()!==i.getChangeEvent()&&i.element.fireEvent(i.getChangeEvent(),new Event.Mock(i.element,i.getChangeEvent())))}),!0}else if(void 0!==(i=this.form.elements[t]))return"auto-complete"===i.options.displayType&&(i.activePopUp=!0),i.update(e),i.baseElementId!==this.element.baseElementId&&(i.element.fireEvent(i.getBlurEvent(),new Event.Mock(i.element,i.getBlurEvent())),i.getBlurEvent()!==i.getChangeEvent()&&i.element.fireEvent(i.getChangeEvent(),new Event.Mock(i.element,i.getChangeEvent()))),!0;return!1}})});