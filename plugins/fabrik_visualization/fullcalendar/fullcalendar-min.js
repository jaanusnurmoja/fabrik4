/*! Fabrik */
var fabrikFullcalendar=new Class({Implements:[Options],options:{url:{del:"index.php?option=com_fabrik&controller=visualization.fullcalendar&view=visualization&task=deleteEvent&format=raw"}},initialize:function(t,e){function i(t,e,i){l=t,r=i.name,jQuery("#calendar").on("mousemove",n)}function n(){l=r=null,jQuery("#calendar").off("mousemove",n)}this.el=document.id(t),this.setOptions(e),this.date=new Date,this.clickdate=null,this.ajax={},this.windowopts={id:"addeventwin",title:"",loadMethod:"xhr",minimizable:!1,evalScripts:!0,width:380,height:320,onContentLoaded:function(t){t.fitToContent()}.bind(this)},"null"!==typeOf(this.el.getElement(".addEventButton"))&&this.el.getElement(".addEventButton").addEvent("click",function(t){this.openAddEvent(t)}.bind(this)),Fabrik.addEvent("fabrik.form.submitted",function(t,e){jQuery("#calendar").fullCalendar("refetchEvents"),Fabrik.Windows.addeventwin.close()}.bind(this));var o=[];this.options.url;this.options.eventLists.each(function(t,e){o.push({events:new Function("start","end","tz","callback","new Request({'url': '"+this.options.url.add+"&listid="+t.value+"&eventListKey="+e+"','evalScripts': true,'onSuccess': function (e, json) {\nif (typeOf(json) !== 'null') {\nthis.processEvents(json, callback);\n}}.bind(this, callback)}).send();").bind(this),color:t.colour})}.bind(this));var a=this,d="";this.options.show_week!==!1&&(d+="agendaWeek"),this.options.show_day!==!1&&(d.length>0&&(d+=","),d+="agendaDay"),d.length>0&&(d="month,"+d);var s="month";switch(this.options.default_view){case"monthView":break;case"weekView":this.options.show_week!==!1&&(s="agendaWeek");break;case"dayView":this.options.show_day!==!1&&(s="agendaDay")}var l=null,r=null;jQuery("#calendar").dblclick(function(t){l&&a.openAddEvent(t,r,l)});var c={header:{left:"prev,next today",center:"title",right:d},fixedWeekCount:!1,timeFormat:this.options.time_format,defaultView:s,nextDayThreshold:"00:00:00",firstDay:this.options.first_week_day,eventSources:o,defaultTimedEventDuration:this.options.minDuration,minTime:this.options.open,maxTime:this.options.close,eventClick:function(t,e,i){return a.clickEntry(t),!1},dayClick:i,viewRender:function(t,e){"month"==t.name&&a.options.greyscaledweekend===!0&&(jQuery("td.fc-sat").css("background","#f2f2f2"),jQuery("td.fc-sun").css("background","#f2f2f2"))},eventRender:function(t,e){e.find(".fc-title").html(t.title)},loading:function(t){t||jQuery(".fc-view-container").delegate(".popover button.jclose","click",function(){var t=jQuery(this).data("popover");jQuery("#"+t).popover("hide")})}};jQuery.extend(!0,c,JSON.parse(a.options.calOptions)),jQuery("#calendar").fullCalendar(c),document.addEvent("click:relay(button[data-task=viewCalEvent], a[data-task=viewCalEvent])",function(t,e){t.preventDefault();var i=t.target.findClassUp("calEventButtons").id;i=i.replace(/_buttons/,"");var n=jQuery("#calendar").fullCalendar("clientEvents",i)[0];jQuery("#"+i).popover("hide"),this.viewEntry(n)}.bind(this)),document.addEvent("click:relay(button[data-task=editCalEvent], a[data-task=editCalEvent])",function(t,e){t.preventDefault();var i=t.target.findClassUp("calEventButtons").id;i=i.replace(/_buttons/,"");var n=jQuery("#calendar").fullCalendar("clientEvents",i)[0];jQuery("#"+i).popover("hide"),this.editEntry(n)}.bind(this)),document.addEvent("click:relay(button[data-task=deleteCalEvent], a[data-task=deleteCalEvent])",function(t,e){t.preventDefault();var i=t.target.findClassUp("calEventButtons").id;i=i.replace(/_buttons/,"");var n=jQuery("#calendar").fullCalendar("clientEvents",i)[0];jQuery("#"+i).popover("hide"),this.deleteEntry(n)}.bind(this)),jQuery(document).on("click",".popover .jclose",function(t,e){t.preventDefault();var i=jQuery(t.target).attr("data-popover");jQuery("#"+i).popover("hide")}.bind(this)),this.ajax.deleteEvent=new Request({url:this.options.url.del,data:{visualizationid:this.options.calendarId},onComplete:function(){jQuery("#calendar").fullCalendar("refetchEvents")}.bind(this)})},processEvents:function(t,e){t=$H(JSON.decode(t));var i=[];t.each(function(t){var e=jQuery(Fabrik.jLayouts["fabrik-visualization-fullcalendar-event-popup"])[0],n=t._listid+"_"+t.id;e.id="fabrikevent_"+n;var o=jQuery(Fabrik.jLayouts["fabrik-visualization-fullcalendar-viewevent"])[0],a=moment(t.startdate_locale),d=moment(t.enddate_locale),s=dispEndDate="";(moment(d.format("YYYY-MM-DD"))>moment(a.format("YYYY-MM-DD"))||t.startShowTime===!1&&t.endShowTime===!1)&&(s=a.format("MMM DD")+" ",dispEndDate=d.format("MMM DD")+" ");var l=dispEndTime="";t.startShowTime===!0&&t.endShowTime===!0&&(l=a.format("hh.mm A"),dispEndTime=d.format("hh.mm A")),o.getElement("#viewstart").innerHTML=s+l,o.getElement("#viewend").innerHTML=dispEndDate+dispEndTime;var r=jQuery(Fabrik.jLayouts["fabrik-visualization-fullcalendar-viewbuttons"])[0];jQuery(r)[0].id="fabrikevent_buttons_"+n;var c=r.getElement(".popupDelete");t._canDelete===!1?c.destroy():c.setProperty("title",Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_DELETE"));var u=r.getElement(".popupEdit");t._canEdit===!1?u.destroy():u.setProperty("title",Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_EDIT"));var v=r.getElement(".popupView");t._canView===!1?v.destroy():v.setProperty("title",Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_VIEW")),jQuery(e).attr("data-content",jQuery(o).prop("outerHTML")+jQuery(r).prop("outerHTML"));var p=""==s?"auto":"200px";jQuery(e).attr("data-title",'<div style="width:'+p+'"><div style="float:left;"><button class="btn jclose" data-popover="'+e.id+'" data-toggle="tooltip" title="'+Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_CLOSE")+'"><i class="icon-delete"></i></button></div><div style="text-align:center;">'+t.label+"</div></div>"),jQuery(e).append(t.label),i.push({id:e.id,title:jQuery(e).prop("outerHTML"),start:t.startdate_locale,end:t.enddate_locale,url:t.link,className:t.status,listid:t._listid,rowid:t.__pk_val,formid:t._formid})}.bind(i)),e(i)},addEvForm:function(t){"undefined"!=typeof jQuery&&jQuery(this.popOver).popover("hide"),this.windowopts.id="addeventwin";var e="index.php?option=com_fabrik&controller=visualization.fullcalendar&view=visualization&task=addEvForm&format=raw&listid="+t.listid+"&rowid="+t.rowid;if(e+="&jos_fabrik_calendar_events___visualization_id="+this.options.calendarId,e+="&visualizationid="+this.options.calendarId,t.nextView&&(e+="&nextview="+t.nextView),e+="&fabrik_window_id="+this.windowopts.id,null!==this.clickdate){var i=jQuery("#calendar").fullCalendar("option","defaultTimedEventDuration").split(":"),n=moment(this.clickdate).add({h:i[0],m:i[1],s:i[2]}).format("YYYY-MM-DD HH:mm:ss");e+="&start_date="+this.clickdate+"&end_date="+n}this.windowopts.type="window",this.windowopts.contentURL=e,this.windowopts.title=t.title;var o=this.options.filters;this.windowopts.onContentLoaded=function(t){o.each(function(t){if(document.id(t.key))switch(document.id(t.key).get("tag")){case"select":document.id(t.key).selectedIndex=t.val;break;case"input":document.id(t.key).value=t.val}}),t.fitToContent(!1)}.bind(this),Fabrik.getWindow(this.windowopts)},viewEntry:function(t){this.clickdate=null;var e={};e.id=t.formid,e.rowid=t.rowid,e.listid=t.listid,e.nextView="details",e.title=Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_VIEW_EVENT"),this.addEvForm(e)},editEntry:function(t){this.clickdate=null;var e={};e.id=t.formid,e.rowid=t.rowid,e.listid=t.listid,e.nextView="form",e.title=Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_EDIT_EVENT"),this.addEvForm(e)},deleteEntry:function(t){confirm(Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_CONF_DELETE"))&&(this.ajax.deleteEvent.options.data={id:t.rowid,listid:t.listid},this.ajax.deleteEvent.send())},clickEntry:function(t){if(this.options.showFullDetails===!1){var e="fabrikevent_"+t.listid+"_"+t.rowid;jQuery("#"+e).popover("show")}else this.viewEntry(t)},openAddEvent:function(t,e,i){var n,o,a,d,s,l,r,c;if(this.options.canAdd!==!1&&("month"!=e||this.options.readonlyMonth!==!0)){switch(t.type){case"dblclick":c=i;break;case"click":t.stop(),c=moment();break;default:return void alert("Unknown event in OpenAddEvent: "+t.type)}"month"==e?a=d="00":(a=(a=c.hour())<10?"0"+a:a,d=(d=c.minute())<10?"0"+d:d),o=(o=c.date())<10?"0"+o:o,s=(s=c.month()+1)<10?"0"+s:s,l=c.year(),this.clickdate=l+"-"+s+"-"+o+" "+a+":"+d+":00",("dblclick"!=t.type||this.dateInLimits(this.clickdate))&&(this.options.eventLists.length>1?this.openChooseEventTypeForm(this.clickdate,n):(r={},r.rowid="",r.id="",r.listid=this.options.eventLists[0].value,r.title=Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_ADD_EVENT"),this.addEvForm(r)))}},dateInLimits:function(t){var e=new moment(t);if(""!==this.options.dateLimits.min){var i=new moment(this.options.dateLimits.min);if(e.isBefore(i))return alert(Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_DATE_ADD_TOO_EARLY")),!1}if(""!==this.options.dateLimits.max){var n=new moment(this.options.dateLimits.max);if(e.isAfter(n))return alert(Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_DATE_ADD_TOO_LATE")),!1}return!0},openChooseEventTypeForm:function(t,e){var i="index.php?option=com_fabrik&tmpl=component&view=visualization&controller=visualization.fullcalendar&task=chooseaddevent&id="+this.options.calendarId+"&d="+t+"&rawd="+e;i+="&renderContext="+this.el.id.replace(/visualization_/,""),this.windowopts.contentURL=i,this.windowopts.id="chooseeventwin",this.windowopts.onContentLoaded=function(){new Fx.Scroll(window).toElement("chooseeventwin")},Fabrik.getWindow(this.windowopts)}});