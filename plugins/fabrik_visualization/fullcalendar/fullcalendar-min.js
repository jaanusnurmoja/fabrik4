/*! Fabrik */
var fabrikFullcalendar=new Class({Implements:[Options],options:{},initialize:function(t,e){this.el=document.id(t),this.setOptions(e),this.date=new Date,this.windowopts={id:"addeventwin",title:"add/edit event",loadMethod:"xhr",minimizable:!1,evalScripts:!0,width:380,height:320,onContentLoaded:function(t){t.fitToContent()}.bind(this)},"null"!==typeOf(this.el.getElement(".addEventButton"))&&this.el.getElement(".addEventButton").addEvent("click",function(t){this.openAddEvent(t)}.bind(this)),Fabrik.addEvent("fabrik.form.submitted",function(t,e){jQuery("#calendar").fullCalendar("refetchEvents"),Fabrik.Windows.addeventwin.close()}.bind(this));var i=[];this.options.url;this.options.eventLists.each(function(t,e){i.push({events:new Function("start","end","tz","callback","new Request({'url': '"+this.options.url.add+"&listid="+t.value+"&eventListKey="+e+"','evalScripts': true,'onSuccess': function (e, json) {\nif (typeOf(json) !== 'null') {\nthis.processEvents(json, callback);\n}}.bind(this, callback)}).send();").bind(this),color:t.colour})}.bind(this));var n=this,o="";this.options.show_week!==!1&&(o+="agendaWeek"),this.options.show_day!==!1&&(o.length>0&&(o+=","),o+="agendaDay"),o.length>0&&(o="month,"+o);var a="month";switch(this.options.default_view){case"monthView":break;case"weekView":this.options.show_week!==!1&&(a="agendaWeek");break;case"dayView":this.options.show_day!==!1&&(a="agendaDay")}var d=this.options.time_format;jQuery("#calendar").fullCalendar({header:{left:"prev,next today",center:"title",right:o},timeFormat:d,defaultView:a,eventSources:i,eventClick:function(t,e,i){return n.viewEntry(t),!1},dayRender:function(t,e){e.bind("dblclick",{date:t},function(t){alert("double click: "+t.data.date.toString());var e="month";n.openAddEvent(t,e,t.data.date)})}})},processEvents:function(t,e){t=$H(JSON.decode(t));var i=[];t.each(function(t){i.push({title:t.label,start:t.startdate_locale,end:t.enddate_locale,url:t.link,listid:t._listid,rowid:t.__pk_val,formid:t._formid})}.bind(i)),e(i)},addEvForm:function(t){"undefined"!=typeof jQuery&&jQuery(this.popOver).popover("hide"),this.windowopts.id="addeventwin";var e="index.php?option=com_fabrik&controller=visualization.fullcalendar&view=visualization&task=addEvForm&format=raw&listid="+t.listid+"&rowid="+t.rowid;e+="&jos_fabrik_calendar_events___visualization_id="+this.options.calendarId,e+="&visualizationid="+this.options.calendarId,t.nextView&&(e+="&nextview="+t.nextView),e+="&fabrik_window_id="+this.windowopts.id,"undefined"!=typeof this.doubleclickdate&&(e+="&start_date="+this.doubleclickdate),this.windowopts.type="window",this.windowopts.contentURL=e;var i=this.options.filters;this.windowopts.onContentLoaded=function(t){i.each(function(t){if(document.id(t.key))switch(document.id(t.key).get("tag")){case"select":document.id(t.key).selectedIndex=t.val;break;case"input":document.id(t.key).value=t.val}}),t.fitToContent(!1)}.bind(this),Fabrik.getWindow(this.windowopts)},viewEntry:function(t){var e={};e.id=t.formid,e.rowid=t.rowid,e.listid=t.listid,e.nextView="details",this.addEvForm(e)},openAddEvent:function(t,e,i){var n,o,a,s,l,r,c,h;this.options.canAdd!==!1&&("monthView"!==this.options.viewType||this.options.readonlyMonth!==!0)&&(t.stop(),t.target.hasClass("addEventButton")?(c=new Date,n=c.getTime()):(c=new Date,c=i.toDate(),n=c.getTime()),this.dateInLimits(n)&&(t.target.get("data-date")&&console.log("data-date = ",t.target.get("data-date")),this.date.setTime(n),d=0,isNaN(n)||""===n||(h=new Date,h.setTime(n),l=h.getMonth()+1,l=10>l?"0"+l:l,o=h.getDate(),o=10>o?"0"+o:o,"month"!==e?(a=h.getHours(),a=10>a?"0"+a:a,s=h.getMinutes(),s=10>s?"0"+s:s):(a="00",s="00"),this.doubleclickdate=h.getFullYear()+"-"+l+"-"+o+" "+a+":"+s+":00",d="&jos_fabrik_calendar_events___start_date="+this.doubleclickdate),this.options.eventLists.length>1?this.openChooseEventTypeForm(this.doubleclickdate,n):(r={},r.rowid="",r.id="",d="&"+this.options.eventLists[0].startdate_element+"="+this.doubleclickdate,r.listid=this.options.eventLists[0].value,this.addEvForm(r))))},dateInLimits:function(t){var e=new Date;if(e.setTime(t),""!==this.options.dateLimits.min){var i=new Date(this.options.dateLimits.min);if(i>e)return alert(Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_DATE_ADD_TOO_EARLY")),!1}if(""!==this.options.dateLimits.max){var n=new Date(this.options.dateLimits.max);if(e>n)return alert(Joomla.JText._("PLG_VISUALIZATION_FULLCALENDAR_DATE_ADD_TOO_LATE")),!1}return!0},openChooseEventTypeForm:function(t,e){var i="index.php?option=com_fabrik&tmpl=component&view=visualization&controller=visualization.fullcalendar&task=chooseaddevent&id="+this.options.calendarId+"&d="+t+"&rawd="+e;i+="&renderContext="+this.el.id.replace(/visualization_/,""),this.windowopts.contentURL=i,this.windowopts.id="chooseeventwin",this.windowopts.onContentLoaded=function(){new Fx.Scroll(window).toElement("chooseeventwin")},Fabrik.getWindow(this.windowopts)}});