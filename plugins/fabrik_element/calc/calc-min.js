var FbCalc=new Class({Extends:FbElement,initialize:function(b,a){this.plugin="calc";this.oldAjaxCalc=null;this.parent(b,a);if(this.element){this.spinner=new Spinner(this.element.getParent())}},attachedToForm:function(){if(this.options.ajax){var b;var a=this.form;this.options.observe.each(function(c){if(this.form.formElements[c]){this.form.formElements[c].addNewEventAux("change",function(d){this.calc(d)}.bind(this))}else{if(this.options.canRepeat){b=c+"_"+this.options.repeatCounter;if(this.form.formElements[b]){this.form.formElements[b].addNewEventAux("change",function(d){this.calc(d)}.bind(this))}}else{this.form.repeatGroupMarkers.each(function(e,d){b="";for(v2=0;v2<e;v2++){b="join___"+this.form.options.group_join_ids[d]+"___"+c+"_"+v2;if(this.form.formElements[b]){this.form.formElements[b].addNewEvent("change",function(f){this.calc(f)}.bind(this))}}}.bind(this))}}}.bind(this))}},calc:function(){this.spinner.show();var a=this.form.getFormElementData();var d=$H(this.form.getFormData(false));d.each(function(f,e){if(e.test(/^join\[\d+\]/)||e.test(/^fabrik_vars/)){a[e]=f}}.bind(this));$H(a).each(function(f,e){var g=this.form.formElements.get(e);if(g&&g.options.inRepeatGroup&&g.options.joinid===this.options.joinid&&g.options.repeatCounter===this.options.repeatCounter){a[g.options.fullName]=f;a[g.options.fullName+"_raw"]=a[e+"_raw"]}}.bind(this));var c={option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"calc",method:"ajax_calc",element_id:this.options.id,formid:this.form.id};c=Object.append(a,c);var b=new Request({url:"",method:"post",data:c,onComplete:function(e){this.spinner.hide();this.update(e);if(this.options.validations){this.form.doElementValidation(this.options.element)}this.element.fireEvent("change",new Event.Mock(this.element,"change"));Fabrik.fireEvent("fabrik.calc.update",[this,e])}.bind(this)}).send()},cloned:function(a){this.parent(a);this.attachedToForm()},update:function(a){if(this.getElement()){this.element.innerHTML=a;this.options.value=a}},getValue:function(){if(this.element){return this.options.value}return false}});